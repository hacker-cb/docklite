---
description: macOS compatibility patterns and cross-platform development
globs: ["scripts/**/*.py", "scripts/**/*.sh", "backend/**/*.py"]
tags: ["macos", "cross-platform", "development"]
---

# macOS Compatibility

## ğŸš¨ FIRST STEP: Setup Development Environment

**MANDATORY ON macOS (AND ALL PLATFORMS):**

```bash
./docklite setup-dev
```

This is **REQUIRED** before starting development. Creates venv, installs dependencies, handles macOS-specific setup automatically.

**NO EXCEPTIONS.** Don't skip this step on macOS thinking dependencies are already installed.

---

## Platform Support

**Development:** âœ… macOS + Linux
**Production:** Linux only

DockLite fully supports **development on macOS** with some platform-specific considerations.

## âœ… What Works on macOS

### Docker
- Docker Desktop for Mac
- All docker commands (`docker compose`, `docker ps`, etc)
- Container management
- Volume mappings
- Hot-reload (backend + frontend)

### Development Workflow
- Building images
- Running services
- Testing (backend pytest + frontend vitest)
- Logs and debugging
- All development CLI commands

### Python CLI
- All development commands (`start`, `stop`, `test`, `logs`)
- Status and monitoring commands
- Database operations (via backend container)

## âŒ What Doesn't Work (Linux-Only)

### Production Deployment Commands

These require Linux and are NOT needed for development:

- `useradd`, `usermod` - system user management
- `sg docker` - docker group switching
- `hostnamectl` - systemd hostname utility
- `setup-user` - creates Linux system users
- `setup-ssh` - configures SSH for deployment

**Solution:** Run deployment commands on Linux production server, not locally.

## ğŸ”§ Writing Cross-Platform Code

### 1. Auto-Detect Paths (NEVER Hardcode!)

**âŒ BAD:**
```python
PROJECT_ROOT = Path("/home/user/docklite")  # Hardcoded path
```

**âœ… GOOD:**
```python
# Auto-detect from script location
SCRIPTS_DIR = Path(__file__).parent.parent.absolute()
PROJECT_ROOT = SCRIPTS_DIR.parent
```

**âœ… GOOD (Bash):**
```bash
# Auto-detect from script location
get_project_root() {
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    echo "$(cd "$script_dir/../.." && pwd)"
}
```

### 2. Docker Group Detection

**âœ… GOOD:**
```python
def has_docker_group() -> bool:
    """Check if current user is in docker group (Linux-specific)."""
    try:
        import os
        # On macOS, docker group doesn't exist - skip sg
        if not shutil.which("sg"):
            return True  # macOS - no group switching needed
        
        docker_group = grp.getgrnam('docker')
        return docker_group.gr_gid in os.getgroups()
    except (KeyError, OSError):
        return True  # No group switching needed
```

**âœ… GOOD (Bash):**
```bash
docker_compose_cmd() {
    # Check if sg command exists (Linux only)
    if command -v sg &> /dev/null && ! groups | grep -q docker; then
        # Linux: Use sg if not in docker group
        sg docker -c "docker-compose $*"
    else
        # macOS or in docker group: run directly
        docker-compose "$@"
    fi
}
```

### 3. Platform-Specific Commands

**Use command existence checks:**

```bash
# Check if Linux-only command exists
if command -v hostnamectl &> /dev/null; then
    # Linux systemd
    hostnamectl set-hostname "$hostname"
else
    # macOS or other
    sudo hostname "$hostname"
fi
```

**Or use try/except in Python:**

```python
def check_root():
    """Check if running as root."""
    try:
        if os.geteuid() != 0:
            raise PermissionError("Must run as root")
    except AttributeError:
        # Windows/macOS may not have geteuid
        pass
```

### 4. Home Directory

**âŒ BAD:**
```python
home = "/home/username"
```

**âœ… GOOD:**
```python
home = Path.home()  # Works on all platforms
```

**âœ… GOOD (Bash):**
```bash
home=$(eval echo ~$username)
```

### 5. User Management (Linux-Only)

**Mark Linux-only functions clearly:**

```python
def create_system_user(username: str):
    """
    Create Linux system user (Linux only).
    
    Raises:
        NotImplementedError: On non-Linux platforms
    """
    if sys.platform != "linux":
        raise NotImplementedError("System user management requires Linux")
    
    subprocess.run(["useradd", "-m", username], check=True)
```

**Or skip entirely:**

```bash
setup_user() {
    # Only run on Linux
    if [[ "$OSTYPE" != "linux-gnu"* ]]; then
        log_error "This command requires Linux"
        exit 1
    fi
    
    useradd -m "$username"
}
```

## ğŸ“‹ macOS Development Setup

### One-Time Setup

```bash
# One command - creates venv and installs everything
./docklite setup-dev
```

**What it does:**
- Creates `.venv/` virtual environment (isolated from system Python)
- Installs CLI dependencies (typer, rich, python-dotenv, PyYAML)
- Creates `.env` from `.env.example`
- Checks Docker
- Makes CLI executable

### Daily Development

```bash
# Using CLI (recommended - uses venv automatically)
./docklite start          # Start services
./docklite status         # Check status
./docklite test           # Run all tests
./docklite logs backend   # View logs
./docklite stop           # Stop services

# Or directly with Docker Compose
docker compose up -d
docker compose exec backend pytest
docker compose exec frontend npm test
docker compose logs -f backend
docker compose down
```

**Note:** `./docklite` wrapper automatically uses `.venv/bin/python` - no manual activation needed!

## ğŸ¯ Best Practices

### DO âœ…

1. **Use venv** for CLI dependencies (`.venv/`) - keeps system Python clean
2. **Auto-detect paths** using `Path(__file__)` or `${BASH_SOURCE[0]}`
3. **Check command existence** before using (`command -v sg`, `shutil.which("sg")`)
4. **Use `Path.home()`** instead of hardcoded home directories
5. **Document Linux-only functions** clearly in docstrings
6. **Test on both platforms** when possible
7. **Run `./docklite setup-dev`** for first-time setup

### DON'T âŒ

1. **Never install CLI dependencies globally** - always use venv
2. **Never hardcode paths** like `/home/user/...`
3. **Don't assume `sg` exists** - check first
4. **Don't use Linux-specific commands** without checks (`useradd`, `hostnamectl`)
5. **Don't use platform-specific groups** without existence checks
6. **Don't run deployment commands on macOS** - use Linux server
7. **Don't use `--break-system-packages`** - venv makes it unnecessary

## ğŸ” Checking Platform

### Python

```python
import sys
import platform

# Check OS
if sys.platform == "darwin":
    # macOS
    pass
elif sys.platform == "linux":
    # Linux
    pass

# Or
if platform.system() == "Darwin":
    # macOS
    pass
```

### Bash

```bash
# Check OS type
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    echo "Running on macOS"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    echo "Running on Linux"
fi

# Or check command existence
if command -v sg &> /dev/null; then
    # Likely Linux
fi
```

## ğŸ†˜ Common Issues

### Issue: ModuleNotFoundError: No module named 'typer'

**Symptom:** CLI fails with import error

**Solution:** Run `./docklite setup-dev` to create venv and install dependencies.

### Issue: CLI commands fail on macOS

**Symptom:** `sg: command not found`

**Solution:** Updated code checks for `sg` existence. Update to latest version.

### Issue: Hardcoded paths break on macOS

**Symptom:** `FileNotFoundError: /home/user/docklite`

**Solution:** Use auto-detection (see examples above).

### Issue: Can't run deployment commands

**Symptom:** `useradd: command not found`

**Solution:** Normal! Deployment commands are Linux-only. Run on production server.

### Issue: Docker group errors

**Symptom:** Permission denied on Docker socket

**Solution:** On macOS, Docker Desktop manages permissions. Restart Docker Desktop.

## ğŸ“ Summary

**For Development:**
- âœ… macOS fully supported
- âœ… One-command setup: `./docklite setup-dev`
- âœ… venv-based CLI (no system pollution)
- âœ… All dev commands work
- âœ… Docker Compose recommended
- âœ… Tests run in containers

**For Production:**
- âš ï¸ Deployment requires Linux
- âœ… Deploy from macOS via SSH/git
- âœ… Run deployment commands on server

**When Writing Code:**
- âœ… Use venv for CLI dependencies
- âœ… Auto-detect paths
- âœ… Check command existence
- âœ… Document Linux-only functions
- âœ… Test on both platforms
